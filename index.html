<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>買い物計算</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="買い物計算">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">

    <style>
        /* スマホでタップした時の青い枠を消す */
        * { -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background-color: #f0f2f5; 
            padding: 20px; 
            margin: 0;
            display: flex; 
            justify-content: center; 
        }
        .container { background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 480px; margin-bottom: 100px; }
        
        .tax-selector { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 12px; }
        .tax-selector label { font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        .category-card { border: 2px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 15px; background: #fff; }
        .category-header { display: flex; gap: 10px; margin-bottom: 10px; }
        .category-name { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-weight: bold; background: #fffbe6; font-size: 1rem; }
        
        .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
        input[type="number"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; text-align: right; font-size: 1.1rem; }
        
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: bold; transition: opacity 0.2s; }
        button:active { opacity: 0.6; }
        
        .del-row { background: #ff7675; color: white; width: 45px; font-size: 1.2rem; }
        .del-cat { background: #b2bec3; color: white; padding: 5px 12px; font-size: 0.8rem; }
        .add-row { background: #e1f5fe; color: #0288d1; width: 100%; padding: 12px; margin-top: 5px; font-size: 1rem; }
        .add-cat { background: #55efc4; color: #2d3436; width: 100%; padding: 18px; font-size: 1.1rem; margin: 10px 0 20px 0; }
        
        .footer-info { margin-top: 15px; border-top: 1px dashed #ccc; padding-top: 10px; font-size: 0.9rem; color: #666; }
        .cat-total-line { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem; margin-top: 5px; color: #2d3436; }
        
        /* 下部に固定される総合計バー */
        .grand-total-box { 
            position: fixed; bottom: 0; left: 0; right: 0;
            background: #2d3436; color: white; padding: 15px; 
            text-align: center; box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .grand-total-val { font-size: 2.2rem; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="tax-selector">
        <label><input type="radio" name="tax-mode" value="exclude" checked onclick="calculate()"> 外税</label>
        <label><input type="radio" name="tax-mode" value="include" onclick="calculate()"> 内税</label>
    </div>

    <div id="list-container"></div>

    <button class="add-cat" onclick="addCategory()">＋ カテゴリを追加</button>
</div>

<div class="grand-total-box">
    <div style="font-size: 0.8rem; opacity: 0.8;">総合計（税込）</div>
    <div class="grand-total-val"><span id="grand-total">0</span><small style="font-size: 1rem; margin-left:5px;">円</small></div>
</div>

<script>
    function addCategory() {
        const container = document.getElementById('list-container');
        const card = document.createElement('div');
        card.className = 'category-card';
        card.innerHTML = `
            <div class="category-header">
                <input type="text" class="category-name" placeholder="カテゴリ名">
                <button class="del-cat" onclick="this.parentElement.parentElement.remove(); calculate();">削除</button>
            </div>
            <div style="margin-bottom:10px;">
                <label style="font-size:0.9rem; cursor:pointer;"><input type="checkbox" class="is-food" onclick="calculate()"> 食料品(8%)</label>
            </div>
            <div class="rows-container">
                <div class="input-row">
                    <input type="number" class="price" placeholder="0" oninput="calculate()" inputmode="decimal">
                    <button class="del-row" onclick="removeRow(this)">×</button>
                </div>
            </div>
            <button class="add-row" onclick="addRow(this)">＋ 行を追加</button>
            <div class="footer-info">
                <div style="display:flex; justify-content:space-between">小計: <span><span class="sub-val">0</span>円</span></div>
                <div style="display:flex; justify-content:space-between">税: <span><span class="tax-val">0</span>円</span></div>
                <div class="cat-total-line">合計: <span><span class="total-val">0</span>円</span></div>
            </div>
        `;
        container.appendChild(card);
        calculate();
    }

    function addRow(btn) {
        const rowsContainer = btn.parentElement.querySelector('.rows-container');
        const div = document.createElement('div');
        div.className = 'input-row';
        div.innerHTML = `
            <input type="number" class="price" placeholder="0" oninput="calculate()" inputmode="decimal">
            <button class="del-row" onclick="removeRow(this)">×</button>
        `;
        rowsContainer.appendChild(div);
        div.querySelector('input').focus();
    }

    function removeRow(btn) {
        const container = btn.parentElement.parentElement;
        if (container.querySelectorAll('.input-row').length > 1) {
            btn.parentElement.remove();
        } else {
            btn.parentElement.querySelector('input').value = '';
        }
        calculate();
    }

    function calculate() {
        const modeInput = document.querySelector('input[name="tax-mode"]:checked');
        if(!modeInput) return;
        const mode = modeInput.value;
        let gTotal = 0;

        const cards = document.querySelectorAll('.category-card');
        cards.forEach(card => {
            const isFood = card.querySelector('.is-food').checked;
            const rate = isFood ? 0.08 : 0.10;
            const prices = card.querySelectorAll('.price');
            
            let sum = 0;
            prices.forEach(p => sum += (parseFloat(p.value) || 0));

            let tax = 0;
            let total = 0;

            if (mode === 'exclude') {
                tax = Math.floor(sum * rate);
                total = sum + tax;
            } else {
                tax = Math.floor(sum - (sum / (1 + rate)));
                total = sum;
            }

            card.querySelector('.sub-val').innerText = sum.toLocaleString();
            card.querySelector('.tax-val').innerText = tax.toLocaleString();
            card.querySelector('.total-val').innerText = total.toLocaleString();
            gTotal += total;
        });

        document.getElementById('grand-total').innerText = gTotal.toLocaleString();
    }

    window.onload = function() {
        if(document.querySelectorAll('.category-card').length === 0) {
            addCategory();
        }
    };
</script>
<script>
  // Service Workerの登録
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('./sw.js').then(function(registration) {
        console.log('ServiceWorker registration successful');
      }, function(err) {
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }
</script>

</body>
</html>